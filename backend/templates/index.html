<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Dashboard - BBQ GmbH Zeiterfassung</title>    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/nav-styles.css">
    <link rel="stylesheet" href="/static/footer-styles.css">    <link rel="icon" href="/static/images/BBQGmbH.png" type="image/png">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/static/js/nav.js" defer></script>
    <script src="/static/js/notifications.js" defer></script>
</head>
<body>
    <header class="main-header">
        <button id="menu-toggle" class="menu-toggle" aria-label="Toggle menu">
            <i class="fas fa-bars"></i>
        </button>
        <div class="logo-container">
            <img src="/static/images/BBQGmbH.png" alt="BBQ GmbH Logo">
            <h1>BBQ GmbH Zeiterfassung</h1>
        </div>
        <nav class="main-nav">
            <ul>
                <li><a href="/index.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="/arbeitszeiten.html"><i class="fas fa-clock"></i> Arbeitszeiten</a></li>
                <li><a href="/urlaub.html"><i class="fas fa-calendar-alt"></i> Urlaub/Abwesenheiten</a></li>
                <li><a href="/urlaube/genehmigen" id="adminLinkApprovals" style="display:none;"><i class="fas fa-check-circle"></i> Urlaubsgenehmigungen</a></li>
                <li><a href="/rollen.html" id="adminLinkRoles" style="display:none;"><i class="fas fa-user-shield"></i> Rollenverwaltung</a></li>
                <li><a href="/admin_benutzer.html" id="adminLinkUsers" style="display:none;"><i class="fas fa-users-cog"></i> Benutzerverwaltung</a></li>
                <li><a href="/info.html"><i class="fas fa-info-circle"></i> Info</a></li>
                <li><a href="/hilfe.html"><i class="fas fa-question-circle"></i> Hilfe</a></li>
                <li><a href="/passwort.html"><i class="fas fa-key"></i> Passwort ändern</a></li>
                <li><button class="logout-button" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        <div class="welcome-message" id="welcomeMessage">Lade Benutzerinformationen...</div>
        
        <div class="page-header">
            <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
        </div>

        <div class="dashboard-grid"> 
            <div class="dashboard-card" id="quick-actions-card">
                <h2><i class="fas fa-bolt"></i> Schnellaktionen</h2>
                <div class="card-content">
                    <div class="quick-actions">
                        <button onclick="window.location.href='/arbeitszeiten.html'"><i class="fas fa-clock"></i> Zeiten erfassen</button>
                        <button onclick="window.location.href='/urlaub.html'"><i class="fas fa-calendar-plus"></i> Abwesenheit beantragen</button>
                    </div>
                </div>
            </div>

            <div class="dashboard-card" id="recent-times-card">
                <h2><i class="fas fa-history"></i> Letzte Zeiteinträge</h2>
                <div class="card-content">
                    <div class="table-wrapper">
                        <table id="timeEntriesTable">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Projekt</th>
                                    <th>Aufgabe</th>
                                    <th>Dauer (Std.)</th>
                                    <th>Kommentar</th>
                                </tr>
                            </thead>
                            <tbody id="timeEntriesTableBody">
                                <tr><td colspan="5">Lade Daten...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-actions">
                    <a href="/arbeitszeiten.html" class="button secondary">Alle Zeiteinträge anzeigen</a>
                </div>
            </div>

            <div class="dashboard-card" id="upcoming-absences-card">
                <h2><i class="fas fa-calendar-check"></i> Meine Abwesenheiten</h2>
                <div class="card-content">
                    <ul id="absencesList" class="absence-list">
                        <li>Lade Daten...</li>
                    </ul>
                </div>
                <div class="card-actions">
                    <a href="/urlaub.html" class="button secondary">Alle Abwesenheiten anzeigen</a>
                </div>
            </div>
        </div>
    </div>    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>Über uns</h3>
                <p>BBQ GmbH ist ein führender Anbieter von Bildungs- und Beratungslösungen für Unternehmen und Institutionen.</p>                <div class="social-links">
                    <a href="/404.html?feature=social" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                    <a href="/404.html?feature=social" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="/404.html?feature=social" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="/404.html?feature=social" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
              <div class="footer-section">
                <h3>Kontakt</h3>
                <p><i class="fas fa-map-marker-alt"></i> Digitalstraße 42, 10115 Berlin</p>
                <p><i class="fas fa-phone"></i> +49 30 12345678</p>
                <p><i class="fas fa-envelope"></i> info@bbqgmbh-projekt.de</p>
            </div>
            
            <div class="footer-section">
                <h3>Links</h3>                <ul>
                    <li><a href="/info.html">Über uns</a></li>
                    <li><a href="/hilfe.html">Hilfe & Support</a></li>
                    <li><a href="/datenschutz.html">Datenschutz</a></li>
                    <li><a href="/impressum.html">Impressum</a></li>
                </ul>
            </div>
        </div>
        
        <div class="copyright-bar">
            <p>&copy; 2025 BBQ GmbH Zeiterfassungssystem. Alle Rechte vorbehalten.</p>
        </div>
    </footer>

    <script>
        // Function to display messages to the user
        function displayMessage(message, type = 'info') {
            const messageContainer = document.getElementById('message-container') || createMessageContainer();
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type}`;
            messageDiv.textContent = message;
            messageContainer.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 5000);
        }

        function createMessageContainer() {
            const container = document.createElement('div');
            container.id = 'message-container';
            container.style.position = 'fixed';
            container.style.top = '20px';
            container.style.right = '20px';
            container.style.zIndex = '1000';
            container.style.width = '300px';
            document.body.appendChild(container);
            return container;
        }

        // Function to handle fetch requests with authorization
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                logout(); 
                throw new Error('No access token found.');
            }

            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            };

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401) {
                logout(); 
                throw new Error('Unauthorized access.');
            }
            return response;
        }

        // Logout function
        function logout() {
            // Clear localStorage
            localStorage.removeItem('accessToken');
            localStorage.removeItem('currentUser');
            
            // Clear sessionStorage
            sessionStorage.removeItem('accessToken');
            sessionStorage.removeItem('currentUser');
            
            // Clear cookies (set them to expire)
            document.cookie.split(";").forEach(function(c) {
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
            });
            
            // Redirect to Login page with capital L
            window.location.href = '/Login.html';
        }
          // Update navigation based on user role
        function updateNavigationBasedOnRole(userData) {
            console.log('Updating navigation based on role:', userData);
            
            const adminLinkRoles = document.getElementById('adminLinkRoles');
            const adminLinkUsers = document.getElementById('adminLinkUsers');
            const adminLinkApprovals = document.getElementById('adminLinkApprovals');

            if (adminLinkRoles) adminLinkRoles.style.display = 'none';
            if (adminLinkUsers) adminLinkUsers.style.display = 'none';
            if (adminLinkApprovals) adminLinkApprovals.style.display = 'none';

            let roleName = '';
            let roleId = null;

            // Handle different role property structures
            if (userData && userData.rolle) {
                roleName = userData.rolle.name ? String(userData.rolle.name).toLowerCase() : '';
                roleId = userData.role_id || userData.rolle.id;
            } else if (userData && userData.role) {
                roleName = userData.role.name ? String(userData.role.name).toLowerCase() : '';
                roleId = userData.role.id;
            } else if (userData && userData.roles && Array.isArray(userData.roles) && userData.roles.length > 0) {
                // If roles is an array of strings
                if (typeof userData.roles[0] === 'string') {
                    roleName = userData.roles[0].toLowerCase();
                } 
                // If roles is an array of objects
                else if (typeof userData.roles[0] === 'object' && userData.roles[0].name) {
                    roleName = String(userData.roles[0].name).toLowerCase();
                    roleId = userData.roles[0].id;
                }
            }

            console.log(`Detected role name: "${roleName}", role ID: ${roleId}`);
            
            // Check for admin/manager roles
            const isAdmin = roleName === 'admin' || roleName === 'administrator' || roleId === 1;
            const isManager = roleName === 'manager' || roleId === 2;
            
            console.log(`Is admin: ${isAdmin}, Is manager: ${isManager}`);

            // Update navigation UI
            if (adminLinkRoles) {
                adminLinkRoles.style.display = (isAdmin || isManager) ? 'inline-block' : 'none';
            }
            if (adminLinkUsers) {
                adminLinkUsers.style.display = (isAdmin || isManager) ? 'inline-block' : 'none';
            }
            if (adminLinkApprovals) {
                adminLinkApprovals.style.display = (isAdmin || isManager) ? 'inline-block' : 'none';
            }
        }

        // Check user role and update UI, including welcome message
        async function checkUserRoleAndUpdateDashboard() {
            const welcomeMessage = document.getElementById('welcomeMessage');
            try {
                // The endpoint for user data was /auth/users/me in the original script, 
                // but other pages use /api/v1/users/me. Standardizing to /api/v1/users/me.
                const response = await fetchWithAuth('/api/v1/users/me'); 
                if (!response.ok) {
                    // fetchWithAuth handles 401 by logging out.
                    // For other errors, display a generic message or log.
                    console.error(`Error fetching user data: ${response.status}`);
                    if(welcomeMessage) welcomeMessage.textContent = 'Willkommen!';
                    // Potentially display a message to the user if appropriate
                    // displayMessage('Fehler beim Laden der Benutzerdaten.', 'error');
                    return; 
                }
                const userData = await response.json();
                localStorage.setItem('currentUser', JSON.stringify(userData));
                updateNavigationBasedOnRole(userData);

                if(welcomeMessage) {
                    welcomeMessage.textContent = `Willkommen, ${userData.vorname} ${userData.nachname}!`;
                }
                
                // Fetch recent time entries and absences
                // Ensure these functions are defined and use fetchWithAuth or pass the token
                await fetchRecentTimeEntries(userData.id);
                await fetchUpcomingAbsences(userData.id);

            } catch (error) {
                console.error('Error in checkUserRoleAndUpdateDashboard:', error);
                if(welcomeMessage) welcomeMessage.textContent = 'Willkommen!';
                // If the error is due to unauthorized access, fetchWithAuth would have handled logout.
                // For other errors, a general message might be useful.
                // displayMessage('Ein Fehler ist aufgetreten. Bitte versuchen Sie es später erneut.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkUserRoleAndUpdateDashboard();
            const logoutButton = document.querySelector('.logout-button');
            if (logoutButton) {
                logoutButton.onclick = logout;
            }        });        // Function to fetch and display recent time entries
        async function fetchRecentTimeEntries(userId) {
            const timeEntriesTableBody = document.getElementById('timeEntriesTableBody');
            try {
                const response = await fetchWithAuth(`/api/v1/time-entries/?limit=5&sort=-datum,-startzeit&benutzer_id=${userId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const entries = await response.json();
                
                if (!timeEntriesTableBody) return;
                
                if (entries.length === 0) {
                    timeEntriesTableBody.innerHTML = '<tr><td colspan="5">Keine Zeiteinträge gefunden</td></tr>';
                    return;
                }
                
                timeEntriesTableBody.innerHTML = '';
                entries.forEach(entry => {
                    const date = new Date(entry.datum);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${date.toLocaleDateString('de-DE')}</td>
                        <td>${entry.projekt?.name || '-'}</td>
                        <td>${entry.aufgabe?.name || '-'}</td>
                        <td>${calculateDuration(entry.startzeit, entry.endzeit)}</td>
                        <td>${entry.beschreibung || '-'}</td>
                    `;
                    timeEntriesTableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching time entries:', error);
                if(timeEntriesTableBody) {
                    timeEntriesTableBody.innerHTML = '<tr><td colspan="5">Fehler beim Laden der Zeiteinträge</td></tr>';
                }
                displayMessage('Fehler beim Laden der Zeiteinträge', 'error');
            }
        }

        // Helper function to calculate duration in hours
        function calculateDuration(start, end) {
            if (!start || !end) return '-';
            const [startHours, startMinutes] = start.split(':').map(Number);
            const [endHours, endMinutes] = end.split(':').map(Number);
            const duration = ((endHours - startHours) * 60 + (endMinutes - startMinutes)) / 60;
            return duration.toFixed(2);
        }

        // Function to fetch and display upcoming absences
        async function fetchUpcomingAbsences(userId) {
            const absencesList = document.getElementById('absencesList');
            try {
                // Filter by user ID and sort by start date
                const response = await fetchWithAuth(`/api/v1/absences/?limit=5&sort=start_datum&benutzer_id=${userId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const absences = await response.json();

                if (!absencesList) return;
                
                if (absences.length === 0) {
                    absencesList.innerHTML = '<li>Keine anstehenden Abwesenheiten</li>';
                    return;
                }
                
                absencesList.innerHTML = '';
                absences.forEach(absence => {
                    const startDate = new Date(absence.start_datum);
                    const endDate = new Date(absence.end_datum);
                    const formattedStartDate = startDate.toLocaleDateString('de-DE');
                    const formattedEndDate = endDate.toLocaleDateString('de-DE');
                    const typeName = absence.abwesenheit_typ?.name || 'Abwesenheit';
                    const status = absence.status || 'unbekannt';
                    const statusColor = status === 'genehmigt' ? 'green' : 
                                      status === 'abgelehnt' ? 'red' : 'orange';
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>${typeName}</strong> <span style="color: ${statusColor};">(${status})</span>: 
                        ${formattedStartDate} bis ${formattedEndDate}
                        ${absence.kommentar ? `<br><em>${absence.kommentar}</em>` : ''}
                    `;
                    absencesList.appendChild(li);
                });
            } catch (error) {
                console.error('Error fetching absences:', error);
                if(absencesList) {
                    absencesList.innerHTML = '<li>Fehler beim Laden der Abwesenheiten</li>';
                }
                displayMessage('Fehler beim Laden der Abwesenheiten', 'error');
            }
        }
        
        // Function to update all dashboard stats with auto-refresh
        function updateDashboardStats() {
            if (window.location.pathname === '/' || window.location.pathname === '/index.html') {
                const userData = localStorage.getItem('currentUser');
                if (userData) {
                    const user = JSON.parse(userData);
                    if (user && user.id) {
                        fetchRecentTimeEntries(user.id);
                        fetchUpcomingAbsences(user.id);
                    }
                }
            }
        }
        
        // Set up auto-refresh
        const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes
        let dashboardRefreshInterval;

        document.addEventListener('DOMContentLoaded', () => {
            checkUserRoleAndUpdateDashboard();
            
            // Initial dashboard update
            updateDashboardStats();
            
            // Set up auto-refresh
            dashboardRefreshInterval = setInterval(updateDashboardStats, REFRESH_INTERVAL);
            
            // Clean up interval when leaving the page
            window.addEventListener('beforeunload', () => {
                if (dashboardRefreshInterval) {
                    clearInterval(dashboardRefreshInterval);
                }
            });
            
            // Set up logout button
            const logoutButton = document.querySelector('.logout-button');
            if (logoutButton) {
                logoutButton.onclick = logout;
            }
        });
    </script>
</body>
</html>

